#!/bin/bash

# Pre-commit hook for Spring Boot projects
# Runs compile check and architecture validation before commits
# Bypass with: git commit --no-verify

set -e

echo "Running pre-commit checks..."

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

CHECKS_FAILED=0

print_error() { echo -e "${RED}✗ $1${NC}"; }
print_success() { echo -e "${GREEN}✓ $1${NC}"; }
print_warning() { echo -e "${YELLOW}! $1${NC}"; }
print_info() { echo "  $1"; }

# Get staged Java files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.java$' || true)

if [ -z "$STAGED_FILES" ]; then
    print_info "No Java files staged, skipping checks"
    exit 0
fi

print_info "Checking $(echo "$STAGED_FILES" | wc -l | xargs) staged Java files..."
echo ""

# Check 1: Compile
echo "1/2 Compiling project..."
if mvn compile -q -DskipTests 2>/dev/null; then
    print_success "Compilation passed"
else
    print_error "Compilation failed"
    CHECKS_FAILED=1
fi

echo ""

# Check 2: Architecture hierarchy
echo "2/2 Checking architecture hierarchy..."
if ./scripts/validate/architecture.sh --staged > /tmp/arch-output.txt 2>&1; then
    print_success "Architecture check passed"
else
    print_error "Architecture violations found"
    cat /tmp/arch-output.txt | grep -E "^✗|^  " | head -10
    CHECKS_FAILED=1
fi

echo ""
echo "----------------------------------------"

if [ $CHECKS_FAILED -eq 1 ]; then
    print_error "Pre-commit checks failed!"
    echo ""
    echo "Bypass with: git commit --no-verify"
    exit 1
else
    print_success "All pre-commit checks passed!"
    exit 0
fi
